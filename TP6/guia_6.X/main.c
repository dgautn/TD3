/******************************************************************************/
/* Files to Include                                                           */
/******************************************************************************/

/* Device header file */
#if defined(__XC16__)
    #include <xc.h>
#elif defined(__C30__)
    #if defined(__dsPIC33E__)
    	#include <p33Exxxx.h>
    #elif defined(__dsPIC33F__)
    	#include <p33Fxxxx.h>
    #endif
#endif


#include <stdint.h>        /* Includes uint16_t definition                    */
#include <stdbool.h>       /* Includes true/false definition                  */

#include "system.h"        /* System funct/params, like osc/peripheral config */
#include "user.h"          /* User funct/params, such as InitApp              */
#include <dsp.h>           /* Libreria para DSP                               */

/******************************************************************************/
/* Global Variable Declaration                                                */
/******************************************************************************/

/* --------------------------- Filtro FIR ------------------------------------*/
FIRStruct filtro;
fractional coeffs[TAPS]__attribute__((space(xmemory), far, aligned(ALIGNED))) = 
        {0xffff,0xfffe,0xffff,0xffff,0x0000,0x0001,0x0002,0x0003,0x0003,0x0002,
        0x0000,0xffff,0xfffd,0xfffc,0xfffb,0xfffc,0xfffe,0x0001,0x0004,0x0006,
        0x0007,0x0007,0x0004,0x0001,0xfffd,0xfff9,0xfff6,0xfff6,0xfff8,0xfffc,
        0x0002,0x0007,0x000c,0x000e,0x000d,0x0009,0x0002,0xfffa,0xfff3,0xffee,
        0xffed,0xfff1,0xfff8,0x0003,0x000d,0x0015,0x0019,0x0017,0x0010,0x0004,
        0xfff6,0xffe9,0xffe2,0xffe0,0xffe7,0xfff3,0x0004,0x0015,0x0022,0x0028,
        0x0024,0x0018,0x0006,0xfff1,0xffde,0xffd3,0xffd1,0xffdb,0xffed,0x0005,
        0x001d,0x002f,0x0037,0x0033,0x0022,0x0009,0xffec,0xffd4,0xffc4,0xffc3,
        0xffcf,0xffe7,0x0006,0x0024,0x003b,0x0044,0x003e,0x002a,0x000b,0xffe9,
        0xffcc,0xffbb,0xffb9,0xffc8,0xffe3,0x0006,0x0027,0x003f,0x0049,0x0042,
        0x002c,0x000c,0xffea,0xffcd,0xffbc,0xffbc,0xffca,0xffe5,0x0005,0x0022,
        0x0037,0x003e,0x0037,0x0024,0x000a,0xffef,0xffdb,0xffd0,0xffd1,0xffdd,
        0xffef,0x0002,0x0012,0x001b,0x001c,0x0016,0x000c,0x0003,0xfffd,0xfffc,
        0xffff,0x0005,0x0008,0x0007,0xffff,0xfff2,0xffe2,0xffd6,0xffd3,0xffdd,
        0xfff3,0x0014,0x0038,0x0055,0x0061,0x0056,0x0033,0xfffb,0xffba,0xff81,
        0xff5f,0xff60,0xff89,0xffd7,0x003a,0x009d,0x00e5,0x00ff,0x00dc,0x007f,
        0xfff7,0xff60,0xfede,0xfe93,0xfe9a,0xfef8,0xffa3,0x0079,0x014a,0x01e2,
        0x0217,0x01cf,0x010e,0xfff3,0xfeba,0xfdaa,0xfd0b,0xfd11,0xfdd1,0xff33,
        0x00f7,0x02be,0x041a,0x04a6,0x0420,0x027d,0xfff1,0xfcef,0xfa1a,0xf828,
        0xf7c6,0xf96e,0xfd51,0x0346,0x0ac5,0x12f9,0x1ae1,0x2174,0x25cd,0xa752,
        0x25cd,0x2174,0x1ae1,0x12f9,0x0ac5,0x0346,0xfd51,0xf96e,0xf7c6,0xf828,
        0xfa1a,0xfcef,0xfff1,0x027d,0x0420,0x04a6,0x041a,0x02be,0x00f7,0xff33,
        0xfdd1,0xfd11,0xfd0b,0xfdaa,0xfeba,0xfff3,0x010e,0x01cf,0x0217,0x01e2,
        0x014a,0x0079,0xffa3,0xfef8,0xfe9a,0xfe93,0xfede,0xff60,0xfff7,0x007f,
        0x00dc,0x00ff,0x00e5,0x009d,0x003a,0xffd7,0xff89,0xff60,0xff5f,0xff81,
        0xffba,0xfffb,0x0033,0x0056,0x0061,0x0055,0x0038,0x0014,0xfff3,0xffdd,
        0xffd3,0xffd6,0xffe2,0xfff2,0xffff,0x0007,0x0008,0x0005,0xffff,0xfffc,
        0xfffd,0x0003,0x000c,0x0016,0x001c,0x001b,0x0012,0x0002,0xffef,0xffdd,
        0xffd1,0xffd0,0xffdb,0xffef,0x000a,0x0024,0x0037,0x003e,0x0037,0x0022,
        0x0005,0xffe5,0xffca,0xffbc,0xffbc,0xffcd,0xffea,0x000c,0x002c,0x0042,
        0x0049,0x003f,0x0027,0x0006,0xffe3,0xffc8,0xffb9,0xffbb,0xffcc,0xffe9,
        0x000b,0x002a,0x003e,0x0044,0x003b,0x0024,0x0006,0xffe7,0xffcf,0xffc3,
        0xffc4,0xffd4,0xffec,0x0009,0x0022,0x0033,0x0037,0x002f,0x001d,0x0005,
        0xffed,0xffdb,0xffd1,0xffd3,0xffde,0xfff1,0x0006,0x0018,0x0024,0x0028,
        0x0022,0x0015,0x0004,0xfff3,0xffe7,0xffe0,0xffe2,0xffe9,0xfff6,0x0004,
        0x0010,0x0017,0x0019,0x0015,0x000d,0x0003,0xfff8,0xfff1,0xffed,0xffee,
        0xfff3,0xfffa,0x0002,0x0009,0x000d,0x000e,0x000c,0x0007,0x0002,0xfffc,
        0xfff8,0xfff6,0xfff6,0xfff9,0xfffd,0x0001,0x0004,0x0007,0x0007,0x0006,
        0x0004,0x0001,0xfffe,0xfffc,0xfffb,0xfffc,0xfffd,0xffff,0x0000,0x0002,
        0x0003,0x0003,0x0002,0x0001,0x0000,0xffff,0xffff,0xfffe,0xffff};
fractional delay[TAPS]__attribute__((space(ymemory), far, aligned(ALIGNED)));
fractional temp[32];

/* --------------------------- Filtro FIR ------------------------------------*/
IIRTransposedStruct filtro_pb, filtro_pa, filtro_pband;
//coeficioentes de los filtros
fractional coeffs_pb[20]__attribute__((space(xmemory))) = {
    0x004f,0x009e,0x73a7,0x004f,0xcb19,
    0x004f,0x009e,0x73a7,0x004f,0xcb19,
    0x004f,0x009e,0x73a7,0x004f,0xcb19,
    0x004f,0x009e,0x73a7,0x004f,0xcb19
};
fractional coeffs_pa[20]__attribute__((space(xmemory))) = {
    0x34f8,0x9610,0x6935,0x34f8,0xd2e1,
    0x34f8,0x9610,0x6935,0x34f8,0xd2e1,
    0x34f8,0x9610,0x6935,0x34f8,0xd2e1,
    0x34f8,0x9610,0x6935,0x34f8,0xd2e1
};
fractional coeffs_pband[40]__attribute__((space(xmemory))) = {
    0x3cc2,0x867c,0x7ace,0x3cc2,0xc4f6,
    0x3cc2,0x867c,0x7ace,0x3cc2,0xc4f6,
    0x3cc2,0x867c,0x7ace,0x3cc2,0xc4f6,
    0x3cc2,0x867c,0x7ace,0x3cc2,0xc4f6,
    0x03c0,0x0780,0x4f5c,0x03c0,0xe178,
    0x03c0,0x0780,0x4f5c,0x03c0,0xe178,
    0x03c0,0x0780,0x4f5c,0x03c0,0xe178,
    0x03c0,0x0780,0x4f5c,0x03c0,0xe178
};

fractional delay1_pb[4]__attribute__((space(ymemory), far)); //tamano delay igual secciones filtro
fractional delay2_pb[4]__attribute__((space(ymemory), far));
fractional delay1_pa[4]__attribute__((space(ymemory), far));
fractional delay2_pa[4]__attribute__((space(ymemory), far));
fractional delay1_pband[8]__attribute__((space(ymemory), far));
fractional delay2_pband[8]__attribute__((space(ymemory), far));

fractional gan_bajo = 0x4000;       // factores de escala para ecualizar
fractional gan_alto = 0x4000;       // inicializado en 0.5
fractional gan_medio = 0x4000;

fractional temp_pb[32];         // Vectores temporales
fractional temp_pa[32];
fractional temp_pband[32];
fractional temp_outiir[32];


/* -------------------------------- FFT --------------------------------------*/
fractcomplex origen[32]__attribute__((space(ymemory), aligned(128)));  // origen de datos
fractcomplex destino[32]__attribute__((space(ymemory), aligned(128))); // destino de datos
fractcomplex giro[16]__attribute__((space(xmemory), aligned(64)));     // factores de giro

int cnt = 0;    // contador de ciclos para actualizacion de muestras FFT
int bit_tx = 1; // indice para enviar los bits del frame_tx

fractional temp_fft[32];
fractional frame_tx[35];


/* ---------------------------------------------------------------------------*/
unsigned int DAC_BufferA[32]__attribute__((space(dma))) = {0}; 
unsigned int DAC_BufferB[32]__attribute__((space(dma))) = {0};
unsigned int ADC_BufferA[32]__attribute__((space(dma)));
unsigned int ADC_BufferB[32]__attribute__((space(dma)));

/******************************************************************************/
/* Main Program                                                               */
/******************************************************************************/

int16_t main(void)
{

    /* Configure the oscillator for the device */
    ConfigureOscillator();

    /* Initialize IO ports and peripherals */
    InitApp();

    /* TODO <INSERT USER APPLICATION CODE HERE> */

    while(1)
    {
        LATBbits.LATB2 = PORTBbits.RB7; // Enciende led1 si se pulsa boton1
    }
}
